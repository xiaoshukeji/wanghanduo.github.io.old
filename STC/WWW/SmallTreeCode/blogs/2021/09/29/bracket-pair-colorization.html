<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from code.visualstudio.com/blogs/2021/09/29/bracket-pair-colorization by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 04 Jan 2023 12:15:05 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="hNs7DXrTySP_X-0P_AC0WulAXvUwgSXEmgfcO2r79dw" />

  <!-- Twitter and Facebook OpenGraph Metadata-->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@code" />

  <meta name="description" content="How we made bracket pair colorization in Visual Studio Code up to 10,000 times faster." />
<meta name="keywords" content="" />
<!-- Twitter and Facebook OpenGraph Metadata-->
<meta name="twitter:card" content="summary_large_image" />
<meta property="og:url" content="bracket-pair-colorization.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="How We Made Bracket Pair Colorization 10,000x Faster In Visual Studio Code" />
<meta property="og:description" content="How we made bracket pair colorization in Visual Studio Code up to 10,000 times faster." />

<meta property="og:image" content="../../../../opengraphimg/opengraph-blog.png" />



  <link rel="shortcut icon" href="../../../../favicon.ico" sizes="128x128" />
  <link rel="apple-touch-icon" href="../../../../apple-touch-icon.png">

  <title>How We Made Bracket Pair Colorization 10,000x Faster In Visual Studio Code</title>

  <link rel="stylesheet" href="../../../../vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../dist/style.css">

  <script type="text/javascript" src="../../../../../js.monitor.azure.com/scripts/c/ms.analytics-web-3.min.js"></script>
  <script>
  window.appInsights = new oneDS.ApplicationInsights();
  window.appInsights.initialize({
    instrumentationKey: "1a3eb3104447440391ad5f2a6ee06a0a-62879566-bc58-4741-9650-302bf2af703f-7103",
    webAnalyticsConfiguration:{ // Web Analytics Plugin configuration
        urlCollectQuery:true, 
        autoCapture: {
          scroll: true,
          pageView: true,
          onLoad: true,
          onUnload: true,
          click: true,
          resize: true,
          jsError: true
        }
    }
  }, []);
  </script>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../../../../www.google-analytics.com/analytics.js','ga');
  </script>  
  <link rel="alternate" type="application/atom+xml" title="RSS Feed for code.visualstudio.com" href="../../../../feed.xml" />
</head>

<body>
  <!-- EU Cookie Compliance JS -->
  <script src="../../../../../wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js"></script>

  <div id="main">
          <div class="navbar-fixed-container">
              <div class="navbar navbar-inverse navbar-fixed-top ">
                  <div id='cookie-banner'></div>        <nav role="navigation" aria-label="Top Level">
                      <div class="container">
                          <div class="nav navbar-header">
                              <a role="button" id="skip-to-content" class="link-button" href="#main-content">Skip to content<i>&nbsp;</i><span class="glyphicon glyphicon-menu-down"></span></a>
                              <a class="navbar-brand" id="navbar-brand" href="../../../../index.html">Visual Studio Code</a>
                              <button type="button" class="navbar-toggle" role="navigation" data-toggle="collapse" data-target=".navbar-collapse" aria-label="Toggle Navigation Menu">
                                  <span class="icon-bar"></span>
                                  <span class="icon-bar"></span>
                                  <span class="icon-bar"></span>
                              </button>
                          </div>
                          <div class="navbar-collapse collapse" role="navigation">
                              <ul class="nav navbar-nav navbar-left">
                                  <li ><a id="nav-docs" href="../../../../docs.html">Docs</a></li>
                                  <li ><a id="nav-updates" href="../../../../updates/v1_74.html">Updates</a></li>
                                  <li class="active" ><a id="nav-blogs" href="../../../../blogs.html">Blog</a></li>
                                  <li ><a id="nav-extend" href="../../../../api.html">API</a></li>
                                  <li><a href="https://marketplace.visualstudio.com/VSCode" target="_blank" id="nav-extensions">Extensions</a></li>
                                  <li ><a id="nav-faqs" href="../../../../docs/supporting/faq.html">FAQ</a></li>
                                  <li ><a id="nav-learn" href="../../../../learn.html">Learn</a></li>
                                  <li class='search visible-xs visible-sm'
                                      ><a href="../../../../Search.html">Search</a></li>
                              </ul>
          
                              <ul class="nav navbar-nav navbar-right" role="presentation">
                                  <!-- Floating search icon -->
                                  <li>
                                      <a href="../../../../Search.html" title="Search" class="btn search-btn" id="nav-search">
                                          <img class="search-icon" src="../../../../assets/icons/search.svg" width="16px" height="16px" alt="Search"/>
                                          <img class="search-icon-inverted" src="../../../../assets/icons/search_dark.svg" width="16px" height="16px" alt="Search" />
                                      </a>
                                  </li>
                                  <!-- Actual search icon -->
                                  <li class="search" role="presentation">
                                      <form class="nav-search search-form" role="search" aria-label="Search">
                                          <div class="input-group" role="presentation">
                                              <input type="text" name="q" class="search-box form-control" placeholder="Search Docs" aria-label="Search text"/>
                                              <span class="input-group-btn">
                                                  <button tabindex="0" class="btn" type="submit" aria-label="Search">
                                                          <img class="search-icon" src="../../../../assets/icons/search.svg" width="16px" height="16px" alt="Search" />
                                                          <img class="search-icon-inverted" src="../../../../assets/icons/search_dark.svg" width="16px" height="16px" alt="Search" />
                                                  </button>
                                              </span>
                                          </div>
                                      </form>                        </li>
                                  <!-- this was hiden in the home and download page, keeping it for now -->
                                  <li><a class="link-button" href="../../../../Download.html" id="nav-download">
                                      <img class="download-icon" src="../../../../assets/icons/download.svg" width="16px" height="16px" alt="Download VS Code"/>
                                      <img class="download-icon-inverted" src="../../../../assets/icons/download-black.svg" width="16px" height="16px" alt="Download VS Code" />
                                      <span>Download</span>
                                  </a></li>
                              </ul>
                          </div>
                      </div>
                  </nav>
              </div>
          </div>          <div class="updates-banner  ">
              <div class="container">
                  <p class="message"><a href="../../../../updates/v1_74.html" id="banner-link-updates">Version 1.74</a> is now available! Read about the new features and fixes from November.</p> 
              </div>
              <div tabindex="0" role="button" title="Dismiss this update" class="dismiss-btn" id="banner-dismiss-btn"><span class="sr-only">Dismiss this update</span><span aria-hidden="true" class="glyph-icon"></span></div>
          </div>      <div role="main" id="main-content">
        <div class="container body-content docs blog">
    <div class="row">
        <div class="col-md-2 docs-navbar-container">
            <nav id="docs-navbar" aria-label="Blog posts" class="docs-nav updates-nav visible-md visible-lg">
            	<h4>Blog posts</h4>
            	<ul class="nav">
            		
            			<li >
            				<a href="../../../2022/12/07/remote-even-better.html" >Remote Development Even Better</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/11/28/vscode-sandbox.html" >VS Code Sandboxing</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/10/04/vscode-community-discussions.html" >VS Code Community Discussions</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/09/15/dev-container-features.html" >Dev Container Features</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/08/16/markdown-language-server.html" >Markdown Language Server</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/07/07/vscode-server.html" >The VS Code Server</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/05/18/dev-container-cli.html" >Dev container CLI</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/04/04/increase-productivity-with-containers.html" >Moving from Local to Remote Development</a>
            			</li>
            		
            			<li >
            				<a href="../../../2022/03/08/the-tutorial-problem.html" >The problem with tutorials</a>
            			</li>
            		
            			<li >
            				<a href="../../11/08/custom-notebooks.html" >Custom Notebooks</a>
            			</li>
            		
            			<li >
            				<a href="../../10/20/vscode-dev.html" >vscode.dev</a>
            			</li>
            		
            			<li >
            				<a href="../../10/11/webview-ui-toolkit.html" >Webview UI Toolkit</a>
            			</li>
            		
            			<li class="active">
            				<a href="bracket-pair-colorization.html" aria-label="Current Page: Bracket Pair Colorization">Bracket Pair Colorization</a>
            			</li>
            		
            			<li >
            				<a href="../../08/05/notebooks.html" >Notebooks</a>
            			</li>
            		
            			<li >
            				<a href="../../07/06/workspace-trust.html" >Workspace Trust</a>
            			</li>
            		
            			<li >
            				<a href="../../06/10/remote-repositories.html" >Remote Repositories</a>
            			</li>
            		
            			<li >
            				<a href="../../06/02/build-2021.html" >Build 2021</a>
            			</li>
            		
            			<li >
            				<a href="../../02/16/extension-bisect.html" >Extension bisect</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/12/03/chromebook-get-started.html" >VS Code on Chromebook</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/07/27/containers-edu.html" >Development Containers in Education</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/07/01/containers-wsl.html" >Dev Containers in WSL 2</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/06/09/go-extension.html" >The Go experience</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/05/14/vscode-build-2020.html" >VS Code at Build</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/05/06/github-issues-integration.html" >GitHub Issues Integration</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/03/02/docker-in-wsl2.html" >Docker in WSL 2</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/02/24/custom-data-format.html" >Custom Data Format</a>
            			</li>
            		
            			<li >
            				<a href="../../../2020/02/18/optimizing-ci.html" >Improving CI Build Times</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/10/31/inspecting-containers.html" >Inspecting Containers</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/10/03/remote-ssh-tips-and-tricks.html" >SSH Tips and Tricks</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/09/03/wsl2.html" >WSL 2</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/07/25/remote-ssh.html" >Remote SSH</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/05/23/strict-null.html" >Strict null checking</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/05/02/remote-development.html" >Remote Development</a>
            			</li>
            		
            			<li >
            				<a href="../../../2019/02/19/lsif.html" >Language Server Index Format</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/12/04/rich-navigation.html" >Rich Code Navigation</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/11/26/event-stream.html" >Event-Stream Package Security Update</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/09/12/engineering-with-azure-pipelines.html" >Using Azure Pipelines</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/09/10/introducing-github-pullrequests.html" >GitHub Pull Requests</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/08/07/debug-adapter-protocol-website.html" >New home for Debug Adapter Protocol</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/07/12/introducing-logpoints-and-auto-attach.html" >Logpoints and auto-attach</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/05/07/live-share-public-preview.html" >Live Share Preview</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/04/25/bing-settings-search.html" >Settings Search</a>
            			</li>
            		
            			<li >
            				<a href="../../../2018/03/23/text-buffer-reimplementation.html" >Text Buffer Reimplementation</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/12/20/chrome-debugging.html" >What's New for Chrome Debugging</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/11/16/connect.html" >Connect 2017</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/11/15/live-share.html" >Introducing Live Share</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/10/24/theicon.html" >The Icon Journey</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/10/03/terminal-renderer.html" >Integrated Terminal Performance</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/09/28/java-debug.html" >Java Debugging</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/08/07/emmet-2.html" >Emmet 2.0</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/06/20/great-looking-editor-roundup.html" >Fresh Paint</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/05/10/build-2017-demo.html" >Build 2017 Demo</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/04/10/sublime-text-roundup.html" >Sublime Text Extension Roundup</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/03/07/extension-pack-roundup.html" >Extension Packs</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/02/12/code-lens-roundup.html" >Extensions using CodeLens</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/02/08/syntax-highlighting-optimizations.html" >Optimizations in Syntax Highlighting</a>
            			</li>
            		
            			<li >
            				<a href="../../../2017/01/15/connect-nina-e2e.html" >Node.js Development with Visual Studio Code and Azure</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/12/12/roundup-customize.html" >Customize VS Code Extension Roundup</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/11/30/hot-exit-in-insiders.html" >Hot Exit Comes to Insiders</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/11/15/formatters-best-practices.html" >Creating a Formatter Extension</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/10/31/js_roundup_2.html" >JavaScript Extensions Part 2</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/09/14/js_roundup_1.html" >JavaScript Extensions Part 1</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/09/08/icon-themes.html" >File Icon Themes</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/07/29/extensions-roundup-git.html" >Extensions Roundup - Fun with Git</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/06/27/common-language-protocol.html" >The Language Server Protocol</a>
            			</li>
            		
            			<li >
            				<a href="../../../2016/05/04/extension-roundup-may.html" >Extensions Roundup</a>
            			</li>
            		
            	</ul>
            </nav>
            <nav id="small-nav" aria-label="Blog posts" class="docs-nav updates-nav hidden-md hidden-lg">
            	<h4>Blogs</h4>
            	<select id="small-nav-dropdown" aria-label="blog posts">
            		
            			<option value="/blogs/2022/12/07/remote-even-better" >Remote Development Even Better</option>
            		
            			<option value="/blogs/2022/11/28/vscode-sandbox" >VS Code Sandboxing</option>
            		
            			<option value="/blogs/2022/10/04/vscode-community-discussions" >VS Code Community Discussions</option>
            		
            			<option value="/blogs/2022/09/15/dev-container-features" >Dev Container Features</option>
            		
            			<option value="/blogs/2022/08/16/markdown-language-server" >Markdown Language Server</option>
            		
            			<option value="/blogs/2022/07/07/vscode-server" >The VS Code Server</option>
            		
            			<option value="/blogs/2022/05/18/dev-container-cli" >Dev container CLI</option>
            		
            			<option value="/blogs/2022/04/04/increase-productivity-with-containers" >Moving from Local to Remote Development</option>
            		
            			<option value="/blogs/2022/03/08/the-tutorial-problem" >The problem with tutorials</option>
            		
            			<option value="/blogs/2021/11/08/custom-notebooks" >Custom Notebooks</option>
            		
            			<option value="/blogs/2021/10/20/vscode-dev" >vscode.dev</option>
            		
            			<option value="/blogs/2021/10/11/webview-ui-toolkit" >Webview UI Toolkit</option>
            		
            			<option value="/blogs/2021/09/29/bracket-pair-colorization" selected>Bracket Pair Colorization</option>
            		
            			<option value="/blogs/2021/08/05/notebooks" >Notebooks</option>
            		
            			<option value="/blogs/2021/07/06/workspace-trust" >Workspace Trust</option>
            		
            			<option value="/blogs/2021/06/10/remote-repositories" >Remote Repositories</option>
            		
            			<option value="/blogs/2021/06/02/build-2021" >Build 2021</option>
            		
            			<option value="/blogs/2021/02/16/extension-bisect" >Extension bisect</option>
            		
            			<option value="/blogs/2020/12/03/chromebook-get-started" >VS Code on Chromebook</option>
            		
            			<option value="/blogs/2020/07/27/containers-edu" >Development Containers in Education</option>
            		
            			<option value="/blogs/2020/07/01/containers-wsl" >Dev Containers in WSL 2</option>
            		
            			<option value="/blogs/2020/06/09/go-extension" >The Go experience</option>
            		
            			<option value="/blogs/2020/05/14/vscode-build-2020" >VS Code at Build</option>
            		
            			<option value="/blogs/2020/05/06/github-issues-integration" >GitHub Issues Integration</option>
            		
            			<option value="/blogs/2020/03/02/docker-in-wsl2" >Docker in WSL 2</option>
            		
            			<option value="/blogs/2020/02/24/custom-data-format" >Custom Data Format</option>
            		
            			<option value="/blogs/2020/02/18/optimizing-ci" >Improving CI Build Times</option>
            		
            			<option value="/blogs/2019/10/31/inspecting-containers" >Inspecting Containers</option>
            		
            			<option value="/blogs/2019/10/03/remote-ssh-tips-and-tricks" >SSH Tips and Tricks</option>
            		
            			<option value="/blogs/2019/09/03/wsl2" >WSL 2</option>
            		
            			<option value="/blogs/2019/07/25/remote-ssh" >Remote SSH</option>
            		
            			<option value="/blogs/2019/05/23/strict-null" >Strict null checking</option>
            		
            			<option value="/blogs/2019/05/02/remote-development" >Remote Development</option>
            		
            			<option value="/blogs/2019/02/19/lsif" >Language Server Index Format</option>
            		
            			<option value="/blogs/2018/12/04/rich-navigation" >Rich Code Navigation</option>
            		
            			<option value="/blogs/2018/11/26/event-stream" >Event-Stream Package Security Update</option>
            		
            			<option value="/blogs/2018/09/12/engineering-with-azure-pipelines" >Using Azure Pipelines</option>
            		
            			<option value="/blogs/2018/09/10/introducing-github-pullrequests" >GitHub Pull Requests</option>
            		
            			<option value="/blogs/2018/08/07/debug-adapter-protocol-website" >New home for Debug Adapter Protocol</option>
            		
            			<option value="/blogs/2018/07/12/introducing-logpoints-and-auto-attach" >Logpoints and auto-attach</option>
            		
            			<option value="/blogs/2018/05/07/live-share-public-preview" >Live Share Preview</option>
            		
            			<option value="/blogs/2018/04/25/bing-settings-search" >Settings Search</option>
            		
            			<option value="/blogs/2018/03/23/text-buffer-reimplementation" >Text Buffer Reimplementation</option>
            		
            			<option value="/blogs/2017/12/20/chrome-debugging" >What's New for Chrome Debugging</option>
            		
            			<option value="/blogs/2017/11/16/connect" >Connect 2017</option>
            		
            			<option value="/blogs/2017/11/15/live-share" >Introducing Live Share</option>
            		
            			<option value="/blogs/2017/10/24/theicon" >The Icon Journey</option>
            		
            			<option value="/blogs/2017/10/03/terminal-renderer" >Integrated Terminal Performance</option>
            		
            			<option value="/blogs/2017/09/28/java-debug" >Java Debugging</option>
            		
            			<option value="/blogs/2017/08/07/emmet-2.0" >Emmet 2.0</option>
            		
            			<option value="/blogs/2017/06/20/great-looking-editor-roundup" >Fresh Paint</option>
            		
            			<option value="/blogs/2017/05/10/build-2017-demo" >Build 2017 Demo</option>
            		
            			<option value="/blogs/2017/04/10/sublime-text-roundup" >Sublime Text Extension Roundup</option>
            		
            			<option value="/blogs/2017/03/07/extension-pack-roundup" >Extension Packs</option>
            		
            			<option value="/blogs/2017/02/12/code-lens-roundup" >Extensions using CodeLens</option>
            		
            			<option value="/blogs/2017/02/08/syntax-highlighting-optimizations" >Optimizations in Syntax Highlighting</option>
            		
            			<option value="/blogs/2017/01/15/connect-nina-e2e" >Node.js Development with Visual Studio Code and Azure</option>
            		
            			<option value="/blogs/2016/12/12/roundup-customize" >Customize VS Code Extension Roundup</option>
            		
            			<option value="/blogs/2016/11/30/hot-exit-in-insiders" >Hot Exit Comes to Insiders</option>
            		
            			<option value="/blogs/2016/11/15/formatters-best-practices" >Creating a Formatter Extension</option>
            		
            			<option value="/blogs/2016/10/31/js_roundup_2" >JavaScript Extensions Part 2</option>
            		
            			<option value="/blogs/2016/09/14/js_roundup_1" >JavaScript Extensions Part 1</option>
            		
            			<option value="/blogs/2016/09/08/icon-themes" >File Icon Themes</option>
            		
            			<option value="/blogs/2016/07/29/extensions-roundup-git" >Extensions Roundup - Fun with Git</option>
            		
            			<option value="/blogs/2016/06/27/common-language-protocol" >The Language Server Protocol</option>
            		
            			<option value="/blogs/2016/05/04/extension-roundup-may" >Extensions Roundup</option>
            		
            	</select>
            </nav>        </div>
        <div class="col-sm-9 col-md-8 body">
            <link rel="stylesheet" href="../../../../assets/katex/katex.min.css"><h1>Bracket pair colorization 10,000x faster</h1>
<p>September 29, 2021 by Henning Dieterichs, <a href="https://twitter.com/hediet_dev" class="external-link" target="_blank">@hediet_dev</a></p>
<p>When dealing with deeply nested brackets in Visual Studio Code, it can be hard to figure out which brackets match and which do not.</p>
<p>To make this easier, in 2016, a user named CoenraadS developed the awesome <a href="https://marketplace.visualstudio.com/items?itemName=CoenraadS.bracket-pair-colorizer" class="external-link" target="_blank">Bracket Pair Colorizer</a> extension to colorize matching brackets and published it to the VS Code Marketplace. This extension became very popular and now is one of the 10 most downloaded extensions on the Marketplace, with over 6 million installs.</p>
<p>To address performance and accuracy problems, in 2018, CoenraadS followed up with <a href="https://marketplace.visualstudio.com/items?itemName=CoenraadS.bracket-pair-colorizer-2" class="external-link" target="_blank">Bracket Pair Colorizer 2</a>, which now also has over 3 millions of installs.</p>
<p>The Bracket Pair Colorizer extension is a good example of the power of VS Code's extensibility and makes heavy use of the <a href="../../../../api/references/vscode-api.html#TextEditor.setDecorations">Decoration API</a> to colorize brackets.</p>
<p><img src="../../../../assets/blogs/2021/09/29/on-off-comparison.drawio.svg" alt="Two screenshots of the same code opened in VS Code. In the first screenshot, bracket pair colorization is disabled, in the second screenshot, it is enabled" loading="lazy"></p>
<p>We are pleased to see that the VS Code Marketplace offers many more such community-provided extensions, all of which help identify matching bracket pairs in very creative ways, including: <a href="https://marketplace.visualstudio.com/items?itemName=2gua.rainbow-brackets" class="external-link" target="_blank">Rainbow Brackets</a>, <a href="https://marketplace.visualstudio.com/items?itemName=rafamel.subtle-brackets" class="external-link" target="_blank">Subtle Match Brackets</a>, <a href="https://marketplace.visualstudio.com/items?itemName=Durzn.brackethighlighter" class="external-link" target="_blank">Bracket Highlighter</a>, <a href="https://marketplace.visualstudio.com/items?itemName=leodevbro.blockman" class="external-link" target="_blank">Blockman</a>, and <a href="https://marketplace.visualstudio.com/items?itemName=wraith13.bracket-lens" class="external-link" target="_blank">Bracket Lens</a>.
This variety of extensions shows that there is a real desire by VS Code users to get better support for brackets.</p>
<h3 id="_the-performance-problem" data-needslink="_the-performance-problem">The performance problem</h3>
<p>Unfortunately, the non-incremental nature of the Decoration API and missing access to VS Code's token information causes the Bracket Pair Colorizer extension to be slow on large files: when inserting a single bracket at the beginning of the <a href="https://github.com/microsoft/TypeScript/blob/8362a0f929d74ff46828016ec67c05744a8dbb3c/src/compiler/checker.ts" class="external-link" target="_blank">checker.ts</a> file of the TypeScript project, which has more than 42k lines of code, it takes about 10 seconds until the colors of all bracket pairs update.
During these 10 seconds of processing, the extension host process burns at 100% CPU and all features that are powered by extensions, such as auto-completion or diagnostics, stop functioning. Luckily, <a href="../../../../api/advanced-topics/extension-host.html#stability-and-performance">VS Code's architecture</a>
ensures that the UI remains responsive and documents can still be saved to disk.</p>
<p>CoenraadS was aware of this performance issue and spent a great amount of effort on increasing speed and accuracy in version 2 of the extension, by reusing the token and bracket parsing engine from VS Code. However, VS Code's API and extension architecture was not designed to allow for high performance bracket pair colorization when hundreds of thousands of bracket pairs are involved. Thus, even in Bracket Pair Colorizer 2, it takes some time until the colors reflect the new nesting levels after inserting <code>{</code> at the beginning of the file:</p>
<p><img src="../../../../assets/blogs/2021/09/29/checker_ts-extension.gif" alt="A video of VS Code showing that the extension needs more than 10 seconds to process the text change in checker.ts" loading="lazy"></p>
<p>While we would have loved to just improve the performance of the extension (which certainly would have required introducing more advanced APIs, optimized for high-performance scenarios), the asynchronous communication between the renderer and the extension-host severely limits how fast bracket pair colorization can be when implemented as an extension. This limit cannot be overcome.
In particular, bracket pair colors should not be requested asynchronously as soon as they appear in the viewport, as this would have caused visible flickering when scrolling through large files. A discussion of this can be found in <a href="https://github.com/microsoft/vscode/issues/128465#issuecomment-879089188" class="external-link" target="_blank">issue #128465</a>.</p>
<h3 id="_what-we-did" data-needslink="_what-we-did">What we did</h3>
<p>Instead, <a href="../../../../updates/v1_60.html#_high-performance-bracket-pair-colorization">in the 1.60 update</a>, we reimplemented the extension in the core of VS Code and brought this time down to less than a millisecond - in this particular example, that is more than 10,000 times faster.</p>
<p>The feature can be enabled by adding the setting <code>&quot;editor.bracketPairColorization.enabled&quot;: true</code>.</p>
<p>Now, updates are no longer noticeable, even for files with hundreds of thousands of bracket pairs. Notice how the bracket-color in line 42,788 reflects the new nesting level immediately after typing <code>{</code> in line 2:</p>
<p><img src="../../../../assets/blogs/2021/09/29/checker_ts-native.gif" alt="A video of VS Code showing that the native implementation needs less than a millisecond to process the text change in checker.ts" loading="lazy"></p>
<p>Once we decided we move it into core, we also took the opportunity to look into how to make it as fast as we can. Who wouldnâ€™t love an algorithmic challenge?</p>
<p>Without being limited by public API design, we could use (2,3)-trees, recursion-free tree-traversal, bit-arithmetic, incremental parsing, and other techniques to reduce the extension's worst-case update <a href="https://en.wikipedia.org/wiki/Time_complexity" class="external-link" target="_blank">time-complexity</a> (that is the time required to process user-input when a document already has been opened) from <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> to <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>3</mn></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^3 N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> with <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> being the document size and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></eq> the edit size, assuming the nesting level of bracket pairs is bounded by <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>.</p>
<p>Additionally, by reusing the existing tokens from the renderer and its incremental token update mechanism, we gained another massive (but constant) speedup.</p>
<h3 id="_vs-code-for-the-web" data-needslink="_vs-code-for-the-web">VS Code for the Web</h3>
<p>Besides being more performant, the new implementation is also supported in <a href="../../../../docs/editor/vscode-web.html">VS Code for the Web</a>, which you can see in action with <a href="https://vscode.dev/" class="external-link" target="_blank">vscode.dev</a> and  <a href="https://docs.github.com/en/codespaces/developing-in-codespaces/web-based-editor" class="external-link" target="_blank">github.dev</a>. Due to the way Bracket Pair Colorizer 2 reuses the VS Code token engine, it was not possible to migrate the extension to be what we call a <a href="../../../../api/extension-guides/web-extensions.html">web extension</a>.</p>
<p>Not only does our new implementation work in VS Code for the Web, but also directly in the <a href="https://microsoft.github.io/monaco-editor/" class="external-link" target="_blank">Monaco Editor</a>!</p>
<h2 id="_the-challenge-of-bracket-pair-colorization" data-needslink="_the-challenge-of-bracket-pair-colorization">The challenge of bracket pair colorization</h2>
<p>Bracket pair colorization is all about quickly determining all brackets and their (absolute) nesting level in the viewport. The viewport can be described as a range in the document in terms of line and column numbers and is usually a tiny fraction of the entire document.</p>
<p>Unfortunately, the nesting level of a bracket depends on <em>all</em> characters preceding it: replacing any character with the opening bracket &quot;<code>{</code>&quot; usually increases the nesting level of all following brackets.</p>
<p>Thus, when initially colorizing brackets at the very end of a document, every single character of the entire document has to be processed.</p>
<p><img src="../../../../assets/blogs/2021/09/29/level-depends-on-all-previous-characters.dio.svg" alt="A diagram that indicates that changing a single character influences the nesting level of all subsequent brackets" loading="lazy"></p>
<p>The implementation in the bracket pair colorizer extension addresses this challenge by processing the entire document again whenever a single bracket is inserted or removed (which is very reasonable to do for small documents). The colors then have to be removed and reapplied using the VS Code <a href="../../../../api/references/vscode-api.html#TextEditor.setDecorations">Decoration API</a>, which sends all color decorations to the renderer.</p>
<p>As demonstrated earlier, this is slow for large documents with hundreds of thousands of bracket pairs and thus equally many color decorations. Because extensions cannot update decorations incrementally and have to replace them all at once, the bracket pair colorizer extension cannot even do much better. Still, the renderer organizes all these decorations in a clever way (by using a so called <a href="https://github.com/microsoft/vscode/blob/534c529c292a96eb775c74dfcee2d733380ed629/src/vs/editor/common/model/intervalTree.ts" class="external-link" target="_blank">interval tree</a>), so rendering is always fast after (potentially hundreds of thousands of) decorations have been received.</p>
<p>Our goal is not having to reprocess the entire document on each key-stroke. Instead, the time required to process a single text edit should only grow (<a href="https://en.wikipedia.org/wiki/Polylogarithmic_function" class="external-link" target="_blank">poly</a>) logarithmically with the document length.</p>
<p>However, we still want to be able to query all brackets and their nesting level in the viewport in (poly) logarithmic time, as it would be the case when using VS Code's decoration API (which uses the mentioned interval tree).</p>
<h3 id="_algorithmic-complexities" data-needslink="_algorithmic-complexities">Algorithmic complexities</h3>
<blockquote>
<p>Feel free to skip the sections on algorithmic complexities.</p>
</blockquote>
<p>In the following, <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> refers to the length of the document.
More formally, our goal is to have a time complexity of at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>k</mi></msup><mi>N</mi><mo>+</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^k N + R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1834479999999998em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9334479999999998em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></eq> for querying all brackets in a given range of size <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></eq> and a reasonable small <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></eq> (we aim for <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">k = 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span></eq>). Brackets are queried when rendering the viewport and thus querying them has to be really fast.</p>
<p>However, we allow an initialization time complexity of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> when a document is opened the first time (which is unavoidable, as all characters have to be processed when initially colorizing brackets) and an update time of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>j</mi></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^j N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.159004em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9090039999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> when <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></eq> many characters are modified or inserted, again for a reasonable small <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></eq> (we aim for <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span></eq>). We also assume that the nesting level of a bracket pair is not too deep and at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> and that the number of closing brackets without an opening counterpart is negligible - documents violating these assumptions are atypical and the algorithm we are looking for does not need to be fast on them.</p>
<h3 id="_language-semantics-make-bracket-pair-colorization-hard" data-needslink="_language-semantics-make-bracket-pair-colorization-hard">Language semantics make bracket pair colorization hard</h3>
<p>What makes bracket pair colorization really difficult is the detection of actual brackets as defined by the document language. In particular, we don't want to detect opening or closing brackets in comments or strings, as the following C example demonstrates:</p>
<pre class="shiki" style="background-color: #FFFFFF"><code><span class="line"><span style="color: #000000">{</span><span style="color: #008000"> /* } */</span><span style="color: #000000"> </span><span style="color: #0000FF">char</span><span style="color: #000000"> str[] = </span><span style="color: #A31515">&quot;}&quot;</span><span style="color: #000000">; }</span></span>
<span class="line"></span></code></pre>
<p>Only the third occurrence of &quot;<code>}</code>&quot; closes the bracket pair.</p>
<p>This gets even harder for languages where the token language is not regular, such as TypeScript with JSX:</p>
<p><img src="../../../../assets/blogs/2021/09/29/tokens-example.dio.svg" alt="Screenshot of TypeScript code, showing a function that contains a template literal with nested expressions. The template literal also contains a closing bracket at position 2. The function starts with the bracket at 1 and ends with the bracket at 3." loading="lazy"></p>
<p>Does the bracket at [1] match the bracket at [2] or at [3]? This depends on the length of the template literal expression, which only a tokenizer with unbounded state (which is a non-regular tokenizer) can determine correctly.</p>
<h3 id="_tokens-to-the-rescue" data-needslink="_tokens-to-the-rescue">Tokens to the rescue</h3>
<p>Luckily, syntax highlighting has to solve a similar problem: should the bracket at [2] in the previous code snippet be rendered as string or as plain text?</p>
<p>As it turns out, just ignoring brackets in comments and strings as identified by syntax highlighting works well enough for most bracket pairs.
<code>&lt;</code> ... <code>&gt;</code> is the only problematic pair we found so far, as these brackets are usually both used for comparisons and as pair for generic types, while having the same token type.</p>
<p>VS Code already has an efficient and synchronous mechanism to maintain token information used for syntax highlighting and we can reuse that to identify opening and closing brackets.</p>
<p>This is another challenge of the Bracket Pair Colorization extension that affects performance negatively: it does not have access to these tokens and has to recompute them on its own. <a href="https://github.com/microsoft/vscode/issues/128465#issuecomment-879089188" class="external-link" target="_blank">We thought long</a> about how we could efficiently and reliably expose token information to extensions, but came to the conclusion that we cannot do this without a lot of implementation details leaking into the extension API. Because the extension still has to send over a list of color decorations for each bracket in the document, such an API alone would not even solve the performance problem.</p>
<p>As a side note, when applying an edit at the beginning of a document that changes all following tokens (such as inserting <code>/*</code> for C-like languages), VS Code does not retokenize long documents all at once, but in chunks over time. This ensures that the UI does not freeze, even though tokenization happens synchronously in the renderer.</p>
<h2 id="_the-basic-algorithm" data-needslink="_the-basic-algorithm">The basic algorithm</h2>
<p>The core idea is to use a <a href="https://en.wikipedia.org/wiki/Recursive_descent_parser" class="external-link" target="_blank">recursive descent parser</a> to build an <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" class="external-link" target="_blank">abstract syntax tree (AST)</a> that describes the structure of all bracket pairs. When a bracket is found, check the token information and skip the bracket if it is in a comment or string. A tokenizer allows the parser to peek and read such bracket or text tokens.</p>
<p>The trick is now to only store the length of each node (and also to have text-nodes for everything that is not a bracket to cover the gaps), instead of storing absolute start/end positions. With only lengths available, a bracket node at a given position can still be located efficiently in the AST.</p>
<p>The following diagram shows an exemplary AST with length annotations:</p>
<p><img src="../../../../assets/blogs/2021/09/29/ast.dio.svg" alt="Abstract Syntax Tree of Bracket Pairs With Relative Lengths" loading="lazy"></p>
<p>Compare this with the classical AST representation using absolute start/end positions:</p>
<p><img src="../../../../assets/blogs/2021/09/29/ast2.dio.svg" alt="Abstract Syntax Tree of Bracket Pairs With Absolute Start/End Positions" loading="lazy"></p>
<p>Both ASTs describe the same document, but when traversing the first AST, the absolute positions have to be computed on the fly (which is cheap to do), while they are already precomputed in the second one.</p>
<p>However, when inserting a single character into the first tree, only the lengths of the node itself and all its parent nodes must be updated - all other lengths stay the same.</p>
<p>When absolute positions are stored as in the second tree, the position of <em>every</em> node later in the document must be incremented.</p>
<p>Also, by not storing absolute offsets, leaf nodes having the same length can be shared to avoid allocations.</p>
<p>This is how the AST with length annotations could be defined in TypeScript:</p>
<pre class="shiki" style="background-color: #FFFFFF"><code><span class="line"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">Length</span><span style="color: #000000"> = ...;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0000FF">type</span><span style="color: #000000"> </span><span style="color: #267F99">AST</span><span style="color: #000000"> = </span><span style="color: #267F99">BracketAST</span><span style="color: #000000"> | </span><span style="color: #267F99">BracketPairAST</span><span style="color: #000000"> | </span><span style="color: #267F99">ListAST</span><span style="color: #000000"> | </span><span style="color: #267F99">TextAST</span><span style="color: #000000">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">/** Describes a single bracket, such as `{`, `}` or `begin` */</span></span>
<span class="line"><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">BracketAST</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">length</span><span style="color: #000000">: </span><span style="color: #267F99">Length</span><span style="color: #000000">) {}</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">/** Describes a matching bracket pair and the node in between, e.g. `{...}` */</span></span>
<span class="line"><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">BracketPairAST</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">openingBracket</span><span style="color: #000000">: </span><span style="color: #267F99">BracketAST</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #267F99">public</span><span style="color: #000000"> </span><span style="color: #267F99">child</span><span style="color: #000000">: </span><span style="color: #267F99">BracketPairAST</span><span style="color: #000000"> | </span><span style="color: #267F99">ListAST</span><span style="color: #000000"> | </span><span style="color: #267F99">TextAST</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #267F99">public</span><span style="color: #000000"> </span><span style="color: #267F99">closingBracket</span><span style="color: #000000">: </span><span style="color: #267F99">BracketAST</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">length</span><span style="color: #000000"> = </span><span style="color: #001080">openingBracket</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000"> + </span><span style="color: #001080">child</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000"> + </span><span style="color: #001080">closingBracket</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000">;</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">/** Describes a list of bracket pairs or text nodes, e.g. `()...()` */</span></span>
<span class="line"><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">ListAST</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(</span></span>
<span class="line"><span style="color: #000000">        </span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">items</span><span style="color: #000000">: </span><span style="color: #267F99">Array</span><span style="color: #000000">&lt;</span><span style="color: #267F99">BracketPairAST</span><span style="color: #000000"> | </span><span style="color: #267F99">TextAST</span><span style="color: #000000">&gt;</span></span>
<span class="line"><span style="color: #000000">    ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">length</span><span style="color: #000000"> = </span><span style="color: #001080">items</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">(</span><span style="color: #001080">item</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">item</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000">);</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #008000">/** Describes text that has no brackets in it. */</span></span>
<span class="line"><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">TextAST</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">length</span><span style="color: #000000">: </span><span style="color: #267F99">Length</span><span style="color: #000000">) {}</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span></code></pre>
<p>Querying such an AST to list all brackets and their nesting level in the viewport is relatively simple: do a depth-first traversal, compute the absolute position of the current node on the fly (by adding the length of earlier nodes), and skip children of nodes that are entirely before or after the requested range.</p>
<p>This basic algorithm already works, but has some open questions:</p>
<ol>
<li>How can we make sure that querying all brackets in a given range has the desired logarithmic performance?</li>
<li>When typing, how can we avoid constructing a new AST from scratch?</li>
<li>How can we handle token chunk updates? When opening a large document, tokens are not available initially, but come in chunk by chunk.</li>
</ol>
<h2 id="_ensuring-that-querytime-is-logarithmic" data-needslink="_ensuring-that-querytime-is-logarithmic">Ensuring that query-time is logarithmic</h2>
<p>What ruins performance when querying brackets in a given range are really long lists: we cannot do a fast binary search on their children to skip all irrelevant non-intersecting nodes, as we need to sum each node's length to compute the absolute position on the fly. In the worst-case, we need to iterate over all of them.</p>
<p>In the following example we have to look at 13 nodes (in blue) until we find the bracket at position 24:</p>
<p><img src="../../../../assets/blogs/2021/09/29/long-lists.dio.svg" alt="Long list in Abstract Syntax Tree" loading="lazy"></p>
<p>While we could compute and cache length sums to enable binary search, this has the same problem as storing absolute positions: we would need to recompute all of them every time a single node grows or shrinks, which is costly for very long lists.</p>
<p>Instead, we allow lists to have other lists as children:</p>
<pre class="shiki" style="background-color: #FFFFFF"><code><span class="line"><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">ListAST</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #001080">items</span><span style="color: #000000">: </span><span style="color: #267F99">Array</span><span style="color: #000000">&lt;</span><span style="color: #267F99">ListAST</span><span style="color: #000000"> | </span><span style="color: #267F99">BracketPairAST</span><span style="color: #000000"> | </span><span style="color: #267F99">TextAST</span><span style="color: #000000">&gt;) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #001080">length</span><span style="color: #000000"> = </span><span style="color: #001080">items</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">(</span><span style="color: #001080">item</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #001080">item</span><span style="color: #000000">.</span><span style="color: #001080">length</span><span style="color: #000000">);</span></span>
<span class="line"><span style="color: #000000">}</span></span>
<span class="line"></span></code></pre>
<p>How does that improve the situation?</p>
<p>If we can ensure that each list only has a bounded number of children and resembles a balanced tree of logarithmic height, it turns out that this is sufficient to get the desired logarithmic performance for querying brackets.</p>
<h3 id="_keeping-list-trees-balanced" data-needslink="_keeping-list-trees-balanced">Keeping list trees balanced</h3>
<p>We use <a href="https://en.wikipedia.org/wiki/2â€“3_tree" class="external-link" target="_blank">(2,3)-trees</a> to enforce that these lists are balanced: every list must have at least 2 and at most 3 children, and all children of a list must have the same height in the balanced list tree. Note that a bracket pair is considered a leaf of height 0 in the balanced tree, but it might have children in the AST.</p>
<p>When constructing the AST from scratch during initialization, we first collect all children and then convert them to such a balanced tree. This can be done in linear time.</p>
<p>A possible (2,3)-tree of the example before could look like the following. Note that we now only need to look at 8 nodes (in blue) to find the bracket pair at position 24 and that there is some freedom whether a list has 2 or 3 children:</p>
<p><img src="../../../../assets/blogs/2021/09/29/long-lists-tree.dio.svg" alt="Balanced tree to describe lists in the AST" loading="lazy"></p>
<h3 id="_worstcase-complexity-analysis" data-needslink="_worstcase-complexity-analysis">Worst-case complexity analysis</h3>
<blockquote>
<p>Feel free to skip the sections on algorithmic complexities.</p>
</blockquote>
<p>For now, we assume that every list resembles a (2,3)-tree and thus has at most 3 children.</p>
<p>To maximize query-time, we have a look at a document that has <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many nested bracket pairs:</p>
<pre class="shiki"><code>{
    {
        ... O(log N) many nested bracket pairs
            {
                {} [1]
            }
        ...
    }
}
</code></pre>
<p>No lists are involved yet, but we already need to traverse <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many nodes to find the bracket pair at [1]. Luckily, documents that are nested even deeper are atypical, so we don't consider them in our worst-case analysis.</p>
<p>Now, for the worst-case, we fill up the document until it has size <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></eq> by inserting additional <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mfrac><mi>N</mi><mrow><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi></mrow></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\frac{N}{\mathrm{log} N})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3534389999999998em;vertical-align:-0.481108em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></eq> many bracket pairs into every nested bracket pair:</p>
<pre class="shiki"><code>{}{}{}{}{}{}{}{}... O(N / log N) many
{
    {}{}{}{}{}{}{}{}... O(N / log N) many
    {
        ... O(log N) many nested bracket pairs
            {
                {}{}{}{}{}{}{}{}... O(N / log N) many
                {} [1]
            }
        ...
    }
}
</code></pre>
<p>Every list of brackets on the same nesting-level yields a tree of height <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mfrac><mi>N</mi><mrow><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi></mrow></mfrac><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo>âˆ’</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mtext>â€…â€Š</mtext><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} \frac{N}{\mathrm{log} N}) = \mathcal{O}(\mathrm{log} N - \mathrm{log}\;\mathrm{log} N ) = \mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3534389999999998em;vertical-align:-0.481108em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.481108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>.</p>
<p>Thus, to find the node at [1], we have to traverse <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many balanced trees of height <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>. Once we found the node and want to collect all brackets in a range of size <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></eq>, we have to read at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></eq> more adjacent leaf nodes connected by at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo>+</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N + R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></eq> internal nodes.</p>
<p>Thus, the worst-case time-complexity of querying brackets is <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo>+</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N + R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></eq>.</p>
<p>Also, this shows that the AST has a maximum height of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>.</p>
<h2 id="_incremental-updates" data-needslink="_incremental-updates">Incremental updates</h2>
<p>The most interesting question of performant bracket pair colorization remains open: given the current (balanced) AST and a text edit that replaces a certain range, how do we efficiently update the tree to reflect the text edit?</p>
<p>The idea is to reuse the recursive descent parser used for initialization and add a caching strategy, so nodes that aren't affected by the text edit can be reused and skipped.</p>
<p>When the recursive descent parser parses a list of bracket pairs at position <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span></eq> and the next edit is at position <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">e</span></span></span></span></eq>, it first checks if the previous AST has a node with a length of at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>âˆ’</mo><mi>p</mi></mrow><annotation encoding="application/x-tex">e - p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span></eq> at the position where <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span></eq> used to be before the text change. If this is the case, this node does not need to be reparsed and the underlying tokenizer can just be advanced by the length of the node. After consuming the node, parsing continues. Note that this node can both be a single bracket pair or an entire list. Also, if there are multiple such reusable nodes, the longest one should be taken.</p>
<p>The following example shows which nodes can be reused (in green) when a single opening bracket is inserted (omitting individual bracket nodes):</p>
<p><img src="../../../../assets/blogs/2021/09/29/long-lists-tree-reuse.dio.svg" alt="Reusable Nodes in AST" loading="lazy"></p>
<p>After processing the text edit by reparsing the nodes that contain edits and reusing all unchanged nodes, the updated AST looks as follows. Note that all 11 reusable nodes can be reused by consuming the 3 nodes B, H and G and only 4 nodes had to be recreated (in orange):</p>
<p><img src="../../../../assets/blogs/2021/09/29/long-lists-tree-reuse2.dio.svg" alt="Updated AST" loading="lazy"></p>
<p>As demonstrated by this example, balanced lists do not only make querying fast, but also help to reuse huge chunks of nodes at once.</p>
<h3 id="_algorithmic-complexity" data-needslink="_algorithmic-complexity">Algorithmic complexity</h3>
<blockquote>
<p>Feel free to skip the sections on algorithmic complexities.</p>
</blockquote>
<p>Let's assume that the text edit replaces a range of size up to <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></eq> with up to <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span></eq> many new characters. We also ignore the rare case of closing brackets that have no opening counterpart for now.</p>
<p>We only have to reparse nodes that intersect the edit range. Thus, at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> many nodes need to be reparsed (with the same reasoning as for the time-complexity of querying brackets) - all other nodes can be reused.</p>
<p>Clearly, if a node does not intersect with the edit range, then neither does any of its children. Thus, we only need to consider reusing nodes that don't intersect with the edit range, but whose parent nodes do (this will implicitly reuse all nodes where both the node and its parent do not intersect with the edit range). Also, such parent nodes cannot be fully covered by the edit range, otherwise all of their children will intersect the edit range. However, every level in the AST only has at most two nodes that partially intersect the edit range. Since an AST has at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many levels (limited by the height of the AST), and every node has at most 3 children, all reusable nodes can be covered by consuming at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>2</mn><mo>â‹…</mo><mn>3</mn><mo>â‹…</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(2 \cdot 3 \cdot \mathrm{log}^2 N) = \mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> nodes.</p>
<p>Thus, to construct the updated tree, we need to reparse at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> many nodes and can reuse <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many nodes.</p>
<p>This would also determine the time complexity of the update operation, but there is a caveat.</p>
<h3 id="_how-do-we-rebalance-the-ast" data-needslink="_how-do-we-rebalance-the-ast">How do we rebalance the AST?</h3>
<p>Unfortunately, the tree in the last example is not balanced anymore.</p>
<p>When combining a reused list node with a newly parsed node, we have to do some work to maintain the (2,3)-tree property. We know that both reused and newly parsed nodes are already (2,3)-trees, but they might have different heights - so we cannot just create parent nodes, since all children of a (2,3)-tree node have to have same height.</p>
<p>How can we efficiently concatenate all these nodes of mixed heights into a single (2,3)-tree?</p>
<p>This can easily be reduced to the problem of prepending or appending a smaller tree to a larger tree: if two trees have the same height, it is sufficient to create a list that contains both children. Otherwise, we insert the smaller tree of height <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">h_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> into the larger tree of height <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">h_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> and potentially break up nodes if they end up having more than 3 children (similar to how the insert operation of (2,3)-trees works).</p>
<p>Because this has runtime <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msub><mi>h</mi><mn>2</mn></msub><mo>âˆ’</mo><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(h_2 - h_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></eq>, we take 3 adjacent nodes (<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span></eq>, <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span></eq>, and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span></eq>) that we want to concatenate and concatenate either <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span></span></span></span></eq> and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span></eq> or <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span></span></span></span></eq> and <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span></eq> first (potentially increasing the height of the tree), depending on which pair has the smaller height difference. This is repeated until all nodes are concatenated. As an additional optimization, we look for sequences of nodes that have the same height and create parent lists for them in linear time.</p>
<p>To balance the lists Î± and Î³ of the previous example, we perform the concat operation on their children (lists in red violate the (2,3)-tree property, nodes in orange have unexpected height and nodes in green are recreated while rebalancing):</p>
<p><img src="../../../../assets/blogs/2021/09/29/long-lists-tree-reuse3.dio.svg" alt="AST after balancing lists" loading="lazy"></p>
<p>Because list B has height 2 and bracket pair Î² height 0 in the unbalanced tree, we need to append Î² to B and are finished with list Î±. The remaining (2,3)-tree is B, thus it becomes the new root and replaces list Î±. Continuing with Î³, its children Î´ and H have height 0, while G has height 1.</p>
<p>We first concat Î´ and H and create a new parent node Y of height 1 (because Î´ and H have the same height). Then we concat Y and G and create a new parent list X (for the same reason). X then becomes the new child of the parent bracket pair, replacing the unbalanced list Î³.</p>
<p>In the example, the balancing operation effectively reduced the height of the top-most list from 3 to 2. However, the total height of the AST got increased from 4 to 5, which negatively impacts the worst-case query time. This is caused by the bracket pair Î², which acts as leaf in the balanced list tree, but actually contains another list of height 2.</p>
<p>Considering the internal AST height of Î² when balancing the parent list could improve the worst-case, but would leave the theory of (2,3)-trees.</p>
<h3 id="_algorithmic-complexity" data-needslink="_algorithmic-complexity">Algorithmic Complexity</h3>
<blockquote>
<p>Feel free to skip the sections on algorithmic complexities.</p>
</blockquote>
<p>We have to concatenate at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> many nodes with a maximum list-height of <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> (those we reused) and additional <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq> many nodes of list-height 0 (those we reparsed).</p>
<p>Because concatenating two nodes of different height has time-complexity <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq> and all reparsed nodes in a list are adjacent and have list-height 0, the time-complexity of the entire update operation is at most <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>3</mn></msup><mi>N</mi><mo>+</mo><mi>E</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^3 N + E)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span></eq>, given that finding a reusable node can be done fast enough.</p>
<h3 id="_how-do-we-find-reusable-nodes-efficiently" data-needslink="_how-do-we-find-reusable-nodes-efficiently">How do we find reusable nodes efficiently?</h3>
<p>We have two data structures for this task: the <em>before edit position mapper</em> and the <em>node reader</em>.</p>
<p>The <a href="https://github.com/microsoft/vscode/blob/f8e9f87b6554b527c61ba963d0c96c7687cbaae9/src/vs/editor/common/model/bracketPairColorizer/beforeEditPositionMapper.ts#L17" class="external-link" target="_blank">position mapper</a> maps a position in the new document (after applying the edit) to the old document (before applying the edit), if possible. It also tells us the length between the current position and the next edit (or 0, if we are in an edit). This is done in <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq>.</p>
<p>When processing a text edit and parsing a node, this component gives us the position of a node that we can potentially reuse and the maximum length this node can have - clearly, the node we want to reuse must be shorter than the distance to the next edit.</p>
<p>The <a href="https://github.com/microsoft/vscode/blob/f8e9f87b6554b527c61ba963d0c96c7687cbaae9/src/vs/editor/common/model/bracketPairColorizer/nodeReader.ts#L13" class="external-link" target="_blank">node reader</a> can quickly find the longest node that satisfies a given predicate at a given position in an AST. To find a node we can reuse, we use the position mapper to look up its old position and its maximum allowed length and then use the node reader to find this node. If we found such a node, we know that it did not change and can reuse it and skip its length.</p>
<p>Because the node reader is queried with monotonously increasing positions, it does not have to start searching from scratch every time, but can do so from the end of the last reused node. Key to this is a recursion-free tree-traversal algorithm that can dive into nodes, but also skip them or go back to parent nodes. When a reusable node is found, traversal stops and continues with the next request to the node reader.</p>
<p>The complexity of querying the node reader a single time is up to <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>, but we are very sure the amortized complexity for all requests issued by a single update operation is also <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mn>2</mn></msup><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log}^2 N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.148448em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.1473400000000002em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>. After all, the node reader is only queried for positions unaffected by the text edit and always takes the shortest path from the last reusable node to the next reusable node. Thus, we think the node reader is efficient enough to not impact the runtime complexity of the update algorithm.</p>
<h2 id="_token-updates" data-needslink="_token-updates">Token updates</h2>
<p>When inserting <code>/*</code> at the beginning of long C-style documents that don't contain the text <code>*/</code>, the entire document becomes a single comment and all tokens change.</p>
<p>Because tokens are computed synchronously in the renderer process, retokenization cannot happen at once without freezing the UI.</p>
<p>Instead, tokens are updated in batches over time, so that the JavaScript event loop is not blocked for too long. While this approach does not reduce the total blocking time, it improves the responsiveness of the UI during the update. The same mechanism is also used when initially tokenizing a document.</p>
<p>Fortunately, due to the incremental update mechanism of the bracket pair AST, we can immediately apply such a batched token update by treating the update as a single text edit that replaces the range that got retokenized with itself. Once all token updates came in, the bracket pair AST is guaranteed to be in the same state as if it had been created from scratch - even if the user edits the document while retokenization is in progress.</p>
<p>That way, not only tokenization is performant even if all tokens in the document change, but also bracket pair colorization.</p>
<p>However, when a document contains a lot of unbalanced brackets in comments, the color of brackets at the end of the document might flicker as the bracket pair parser learns that these brackets should be ignored.</p>
<p>To avoid flickering of bracket pair colors when opening a document and navigating to its end, we maintain two bracket pair ASTs until the initial tokenization process completes.
The first AST is built without token information and does not receive token updates. The second one initially is a clone of the first AST, but receives token updates and diverges more and more as tokenization progresses and token updates are applied. Initially, the first AST is used to query brackets, but the second one takes over once the document is fully tokenized.</p>
<p>Because deep cloning is almost as expensive as reparsing the document, we implemented copy-on-write, enabling cloning in <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq>.</p>
<h2 id="_encoding-of-lengths" data-needslink="_encoding-of-lengths">Encoding of lengths</h2>
<p>The editor view describes the viewport with line and column numbers. Color-decorations are also expected to be expressed as line/column based ranges.</p>
<p>To avoid conversions between offset and line/column based positions (which can be done in <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\mathrm{log} N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></eq>),
we use line/column based lengths for the AST too.</p>
<p>Note that this approach is significantly different from data structures that are directly indexed by lines (such as using a string array to describe the line contents of a document). In particular, this approach can do a single binary search across and within lines.</p>
<p>Adding two such lengths is easy, but requires a case distinction: while the line counts are added directly, the column count of the first length is only included if the second length spans zero lines.</p>
<p>Surprisingly, most of the code does not need to be aware of how lengths are represented. Only the position mapper got significantly more complex, since care had to be taken that a single line can contain multiple text edits.</p>
<p>As an implementation detail, we encode such lengths in a single number to reduce memory pressure. JavaScript supports integers up to <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup><mo>âˆ’</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{53} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></eq>, so we can use up to 26 bits each for the number of lines and columns. Unfortunately, v8 stores numbers larger than <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>31</mn></msup></mrow><annotation encoding="application/x-tex">2^{31}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span></span></span></span></eq> <a href="https://v8.dev/blog/react-cliff#smi-heapnumber-mutableheapnumber" class="external-link" target="_blank">in the heap</a>, so this encoding trick did not turn out as effective as we thought.</p>
<h2 id="_further-difficulties-unclosed-bracket-pairs" data-needslink="_further-difficulties-unclosed-bracket-pairs">Further difficulties: Unclosed bracket pairs</h2>
<p>So far, we assumed that all bracket pairs are balanced. However, we also want to support unclosed and unopened bracket pairs.
The beauty of a recursive descent parser is that we can use anchor sets to improve error recovery.</p>
<p>Consider the following example:</p>
<pre class="shiki"><code>( [1]
} [2]
) [3]
</code></pre>
<p>Clearly <code>}</code> at [2] does not close any bracket pair and represents an unopened bracket. The brackets at [1] and [3] match nicely.
However, when inserting <code>{</code> at the beginning of the document, the situation changes:</p>
<pre class="shiki"><code>{ [0]
( [1]
} [2]
) [3]
</code></pre>
<p>Now, [0] and [2] should be matched, while [1] is an unclosed bracket and [3] an unopened bracket.</p>
<p>In particular, [1] should be an unclosed bracket terminating before [2] in the following example:</p>
<pre class="shiki"><code>{
    ( [1]
} [2]
{}
</code></pre>
<p>Otherwise, opening a parenthesis could change the nesting-level of unrelated following bracket pairs.</p>
<p>To support this kind of error recovery, anchor sets can be used to track the set of expected tokens the caller can continue with. At position [1] in the previous example, the anchor set would be <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo></mrow><annotation encoding="application/x-tex">\{</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span></span></span></span></eq> <code>}</code> <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">}</span></span></span></span></eq>. Thus, when parsing the bracket pair at [1] finds the unexpected bracket <code>}</code> at [2], it does not consume it and returns an unclosed bracket pair.</p>
<p>In the first example, the anchor set at [2] is <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo></mrow><annotation encoding="application/x-tex">\{</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span></span></span></span></eq> <code>)</code> <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">}</span></span></span></span></eq>, but the unexpected character is <code>}</code>. Because it is not part of the anchor set, it is reported as an unopened bracket.</p>
<p>This needs to be considered when reusing nodes: the pair <code>( } )</code> cannot be reused when prepending it with <code>{</code>. We use bit-sets to encode anchor sets and compute the set of containing unopened brackets for every node. If they intersect, we cannot reuse the node. Luckily, there are only a few bracket types, so this does not affect performance too much.</p>
<h2 id="_going-forward" data-needslink="_going-forward">Going forward</h2>
<p>Efficient bracket pair colorization was a fun challenge. With the new data structures, we can also solve other problems related to bracket pairs more efficiently, such as <a href="../../../../docs/editor/editingevolved.html#_bracket-matching">general bracket matching</a> or <a href="https://github.com/microsoft/vscode/issues/131001" class="external-link" target="_blank">showing colored line scopes</a>.</p>
<p>Even though JavaScript might not be the best language to write high performance code, a lot of speed can be gained by reducing asymptotic algorithmic complexity, especially when dealing with large inputs.</p>
<p>Happy Coding!</p>
<p>Henning Dieterichs, VS Code Team member <a href="https://twitter.com/hediet_dev" class="external-link" target="_blank">@hediet_dev</a></p>

        </div>
        <div class="col-sm-3 col-md-2 docs-subnavbar-container">
            <nav id="docs-subnavbar" aria-label="On Page" data-spy="affix" data-offset-top="20">
                
                <h4><span class="sr-only">In this blog post, there are 8
                        sections</span><span aria-hidden="true">In this blog post</span></h4>
                
                <ul class="nav">
                    
                    <li><a href="#_the-challenge-of-bracket-pair-colorization">The challenge of bracket pair colorization</a></li>
                    
                    <li><a href="#_the-basic-algorithm">The basic algorithm</a></li>
                    
                    <li><a href="#_ensuring-that-querytime-is-logarithmic">Ensuring that query-time is logarithmic</a></li>
                    
                    <li><a href="#_incremental-updates">Incremental updates</a></li>
                    
                    <li><a href="#_token-updates">Token updates</a></li>
                    
                    <li><a href="#_encoding-of-lengths">Encoding of lengths</a></li>
                    
                    <li><a href="#_further-difficulties-unclosed-bracket-pairs">Further difficulties: Unclosed bracket pairs</a></li>
                    
                    <li><a href="#_going-forward">Going forward</a></li>
                    
                </ul>
                <div class="connect-widget"></div>
            </nav>
        </div>
    </div>
</div>
      </div>
  </div>

  <footer role="contentinfo">
      <div class="container">
          <div class="row">
              <div class="left col-md-7">
                  <ul class="links">
                      <li>
                          <span class="message">Hello from Seattle.</span>
                      </li>
                      <li>
                          <a href="https://go.microsoft.com/fwlink/?LinkID=533687" onclick="followOnTwitter()" tabindex="0">Follow @code</a>
                      </li>
                      <li>
                          <div class="github-star-button">
                              <iframe src="../../../../assets/github-button29be.html?user=Microsoft&amp;repo=vscode&amp;type=star&amp;count=true"
                                  frameborder="0" scrolling="0" width="130px" height="20px" title="GitHub follow button" loading="lazy"></iframe>
                          </div>
                      </li>
  
                      <script>
                          function followOnTwitter() {
                              var windowFeatures = "location=yes,height=600,width=550,scrollbars=yes,status=yes";
                              var originalReferer = "&original_referer=" + document.URL;
                              var screenName = "&screen_name=code";
                              var URL = "https://twitter.com/intent/follow?" + originalReferer + screenName;
                              window.open(URL, "_blank", windowFeatures);
                          }
  
                          function manageConsent() {
                              if(WcpConsent.siteConsent.isConsentRequired){
                                  WcpConsent.siteConsent.manageConsent();
                              }
                          }
                      </script>
                  </ul>
              </div>
              <div class="right col-md-5">
                  <ul class="links">
                      <li><a id="footer-support-link" href="https://support.serviceshub.microsoft.com/supportforbusiness/create?sapId=d66407ed-3967-b000-4cfb-2c318cad363d"
                              target="_blank">Support</a></li>
                      <li><a id="footer-privacy-link" href="https://privacy.microsoft.com/privacystatement"
                              target="_blank">Privacy</a></li>
                      <li style="display: none;"><a id="footer-cookie-link" style="cursor: pointer;" onclick="manageConsent()"
                              target="_blank">Manage Cookies</a></li>
                      <li><a id="footer-terms-link" href="https://www.microsoft.com/legal/terms-of-use"
                              target="_blank">Terms of Use</a></li>
                      <li><a id="footer-license-link" href="../../../../License.html">License</a></li>
                  </ul>
                  <div class="copyright">
                      <a id="footer-microsoft-link" class="logo" href="https://www.microsoft.com/">
                          <img class="microsoft-logo" src="../../../../assets/images/microsoft-logo.png" height="20" alt="Microsoft homepage"/>
                          <img class="microsoft-logo-inverted" src="../../../../assets/images/microsoft-logo-inverted.png" height="20" alt="Microsoft homepage" />
                      </a>
                      <span>&copy; 2023 Microsoft</span>
                  </div>
              </div>
          </div>
      </div>
  </footer>
  <script src="../../../../dist/index.js"></script>

  

  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "SoftwareApplication",
      "name" : "Visual Studio Code",
      "softwareVersion": "1.74",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "applicationCategory": "DeveloperApplication",
      "applicationSubCategory": "Text Editor",
      "alternateName": "VS Code",
      "datePublished": "2021-11-03",
      "operatingSystem": "Mac, Linux, Windows",
      "logo": "https://code.visualstudio.com/assets/apple-touch-icon.png",
      "screenshot": "https://code.visualstudio.com/assets/home/home-screenshot-win.png",
      "releaseNotes": "https://code.visualstudio.com/updates",
      "downloadUrl": "https://code.visualstudio.com/download",
      "license": "https://code.visualstudio.com/license",
      "softwareRequirements": "https://code.visualstudio.com/docs/supporting/requirements",
      "url" : "https://code.visualstudio.com",
      "author": {
        "@type": "Organization",
        "name": "Microsoft"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Microsoft"
      },
      "maintainer": {
        "@type": "Organization",
        "name": "Microsoft"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://code.visualstudio.com/Search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      },
      "sameAs" : [
        "https://en.wikipedia.org/wiki/Visual_Studio_Code",
        "https://twitter.com/code",
        "https://www.youtube.com/code",
        "https://www.tiktok.com/@vscode",
        "https://github.com/microsoft/vscode"
      ]
    }
  </script>
</body>

<!-- Mirrored from code.visualstudio.com/blogs/2021/09/29/bracket-pair-colorization by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 04 Jan 2023 12:15:06 GMT -->
</html>